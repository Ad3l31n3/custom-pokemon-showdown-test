{
  "version": 3,
  "sources": ["../../../server/chat-plugins/transfer.ts"],
  "sourcesContent": ["import {FS} from \"../../lib\";\nimport {Badges} from \"./badges\";\nimport {LadderStore} from '../ladders-local';\nimport {transferTourWins} from \"./data-badges\";\n\nconst TRANSFER_COOLDOWN = 7 * 24 * 60 * 60 * 1000; // 1 week\n\ninterface UserTransfer {\n\tsourceId: string;\n\ttargetId: string;\n\tisComplete: boolean;\n\tcompleted?: number;\n}\n\ntype Transfers = Record<string, UserTransfer>;\n\nconst transfers: Transfers = JSON.parse(\n\tFS('config/chat-plugins/transfer.json').readIfExistsSync() || \"{}\"\n);\n\nconst saveTransfers = () => {\n\tFS('config/chat-plugins/transfer.json').writeUpdate(() => JSON.stringify(transfers));\n};\n\nconst checkCooldown = (userId: string) => {\n\treturn Object.values(transfers).filter((transfer) => {\n\t\tif ((transfer.sourceId !== userId) && (transfer.targetId !== userId)) return false;\n\t\tif (!transfer.isComplete) return false;\n\t\tif (transfer.completed && ((transfer.completed + TRANSFER_COOLDOWN) < Date.now())) return false;\n\t\treturn true;\n\t});\n};\n\nconst userInBattle = (user: User) => {\n\tconst curBattles: [User, string][] = [...user.inRooms]\n\t\t.filter(id => {\n\t\t\tconst battle = Rooms.get(id)?.battle;\n\t\t\treturn (\n\t\t\t\tbattle && battle.playerTable[user.id]\n\t\t\t);\n\t\t})\n\t\t.map(id => [user, id]);\n\n\treturn curBattles.length !== 0;\n};\n\nexport const commands: Chat.ChatCommands = {\n\ttransfer: {\n\t\tstart(target, room, user) {\n\t\t\tif (transfers[user.id]) throw new Chat.ErrorMessage('You have already started a transfer. Please use /transfer cancel to cancel it first.');\n\t\t\tconst targetId = toID(target);\n\t\t\tif (target.length < 0) {\n\t\t\t\tthrow new Chat.ErrorMessage('Please provide a valid user to transfer to.');\n\t\t\t}\n\t\t\tif (targetId === user.id) throw new Chat.ErrorMessage('You cannot transfer to yourself.');\n\t\t\tif (checkCooldown(user.id)) throw new Chat.ErrorMessage('You have already transferred to another user in the last week. Please wait 7 days between transfers.');\n\t\t\tif (checkCooldown(targetId)) throw new Chat.ErrorMessage('Target user has already transferred to another user in the last week. Please wait 7 days between transfers.');\n\t\t\ttransfers[user.id] = {\n\t\t\t\tsourceId: user.id,\n\t\t\t\ttargetId: targetId,\n\t\t\t\tisComplete: false,\n\t\t\t};\n\t\t\tsaveTransfers();\n\n\t\t\treturn this.sendReplyBox(`Transfer to ${targetId} successfully initiated.`);\n\t\t},\n\t\tcancel(target, room, user) {\n\t\t\tif (!transfers[user.id]) throw new Chat.ErrorMessage('You have not started a transfer.');\n\t\t\tdelete transfers[user.id];\n\t\t\tsaveTransfers();\n\n\t\t\treturn this.sendReplyBox('Transfer successfully canceled.');\n\t\t},\n\t\tasync accept(target, room, user) {\n\t\t\tconst targetId = toID(target);\n\t\t\tconst transfer = transfers[targetId];\n\t\t\tif (!transfer || transfer.targetId !== user.id) throw new Chat.ErrorMessage(`No transfer has been initiated between you and ${targetId}.`);\n\t\t\tif (transfer.isComplete) throw new Chat.ErrorMessage('Transfer has already been completed.');\n\t\t\tif (userInBattle(user)) throw new Chat.ErrorMessage('You cannot accept a transfer while in a battle.');\n\t\t\tif (checkCooldown(user.id)) throw new Chat.ErrorMessage('You have already transferred to another user in the last week. Please wait 7 days between transfers.');\n\t\t\tif (checkCooldown(targetId)) throw new Chat.ErrorMessage('Target user has already transferred to another user in the last week. Please wait 7 days between transfers.');\n\n\t\t\tconst sourceId = transfer.sourceId;\n\n\t\t\tconst updatedRows = await LadderStore.changeName(sourceId, user.name);\n\t\t\tconst allBadges = await Badges.getUserBadges(sourceId);\n\n\t\t\tif (allBadges.length) {\n\t\t\t\tfor (const badge of allBadges) {\n\t\t\t\t\tawait Badges.removeBadgeFromUser(sourceId, badge.badge_id, user, true);\n\t\t\t\t\tawait Badges.addBadgeToUser(user.id, badge.badge_id, user, true);\n\t\t\t\t\tif (badge.badge_data) {\n\t\t\t\t\t\tawait Badges.updateBadgeData(user.id, badge.badge_id, badge.badge_data, user, true);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tawait transferTourWins(targetId, user.id, user);\n\n\t\t\ttransfers[targetId].isComplete = true;\n\t\t\ttransfers[targetId].completed = Date.now();\n\t\t\tsaveTransfers();\n\n\t\t\treturn this.sendReplyBox(`Successfuly transfered ladder data and badges. Raw data: ${JSON.stringify({rating: updatedRows, badges: allBadges})}`);\n\t\t},\n\t},\n\ttransferhelp() {\n\t\tthis.sendReplyBox(\n\t\t\t`<code>/transfer start [new user]</code>: Begins a transfer of user data from your current user to a desired target user. Use this command on your old user.<br />` +\n\t\t\t`<code>/transfer cancel</code>: Cancels an in-progress transfer started from your current user.<br />` +\n\t\t\t`<code>/transfer accept [old user]</code>: Accepts a transfer from another user to your current user. Use this command on your new user.`\n\t\t);\n\t},\n};\n"],
  "mappings": "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",
  "names": []
}
